(()=>{var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{"use strict";e.r(t);const s=flarum.core.compat["forum/app"];var n=e.n(s);const r=flarum.core.compat["common/models/User"];var a=e.n(r);const o=flarum.core.compat["common/Model"];var i=e.n(o);function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function c(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,u(e,t)}const l=flarum.core.compat["common/utils/computed"];var d=e.n(l);const p=flarum.core.compat["common/utils/mixin"];var h=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t}(e.n(p)()(i(),{user:i().hasOne("user"),status:i().attribute("status"),reason:i().attribute("reason"),createdAt:i().attribute("createdAt",i().transformDate),forNickname:i().attribute("forNickname"),_requestedUsername:i().attribute("requestedUsername"),requestedUsername:d()("_requestedUsername","forNickname","user",(function(e,t,s){return null===e&&t?s.username():e}))}));const f=flarum.core.compat["common/extend"],q=flarum.core.compat["common/components/Button"];var v=e.n(q);const N=flarum.core.compat["forum/components/SettingsPage"];var y=e.n(N);const b=flarum.core.compat["common/utils/Stream"];var g=e.n(b);const _=flarum.core.compat["common/components/Modal"];var k=e.n(_),w=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.username=g()(this.attrs.nickname?n().session.user.displayName():n().session.user.username()),this.userRequestAttr="last"+(this.attrs.nickname?"Nickname":"Username")+"Request",this.lastRequest=n().session.user[this.userRequestAttr](),this.lastRequest&&this.username(this.lastRequest.requestedUsername()),this.success=!1,this.password=g()(""),this.translationPrefix="piwind-username-request.forum."+(this.attrs.nickname?"nickname":"username")+"_modals.request"},s.className=function(){return"RequestUsernameModal Modal--small"},s.title=function(){return n().translator.trans(this.translationPrefix+".title")},s.content=function(){return this.success?m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("p",{className:"helpText"},n().translator.trans(this.translationPrefix+".confirmation_message")),m("div",{className:"Form-group"},m(v(),{className:"Button Button--primary Button--block",onclick:this.hide.bind(this)},n().translator.trans(this.translationPrefix+".dismiss_button"))))):m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.lastRequest?m("p",{className:"helpText"},n().translator.trans(this.translationPrefix+".current_request",{name:this.lastRequest.requestedUsername()})):"",m("div",{className:"Form-group"},m("input",{type:"text",name:"text",className:"FormControl",placeholder:n().session.user.username(),bidi:this.username,disabled:this.deleteLoading||this.submitLoading})),n().forum.attribute("passwordlessSignUp")?null:m("div",{className:"Form-group"},m("input",{type:"password",name:"password",className:"FormControl",placeholder:n().translator.trans("core.forum.change_email.confirm_password_placeholder"),bidi:this.password,disabled:this.deleteLoading||this.submitLoading})),m("div",{className:"Form-group"},v().component({className:"Button Button--primary Button--block",type:"submit",loading:this.submitLoading},n().translator.trans(this.translationPrefix+".submit_button"))),this.lastRequest?m("div",{className:"Form-group"},v().component({className:"Button Button--primary Button--block",onclick:this.deleteRequest.bind(this),loading:this.deleteLoading},n().translator.trans(this.translationPrefix+".delete_button"))):""))},s.deleteRequest=function(e){e.preventDefault(),this.deleteLoading=!0,this.lastRequest.delete(),this.successAlert=n().alerts.show({type:"success"},n().translator.trans(this.translationPrefix+".deleted")),n().session.user[this.userRequestAttr]=g()(),this.hide()},s.onsubmit=function(e){var t=this;e.preventDefault(),this.alert=null;var s=this.attrs.nickname?n().session.user.displayName():n().session.user.username();this.username()!==s?(this.submitLoading=!0,n().store.createRecord("username-requests").save({username:this.username(),forNickname:this.attrs.nickname},{meta:{password:this.password()},errorHandler:this.onerror.bind(this)}).then((function(e){n().session.user[t.userRequestAttr]=g()(e),t.success=!0,t.alertAttrs=null})).catch((function(){})).then(this.loaded.bind(this))):this.hide()},s.onerror=function(t){401===t.status&&(t.alert.content=n().translator.trans("core.forum.change_email.incorrect_password_message"),this.submitLoading=!1),e.prototype.onerror.call(this,t)},t}(k());const x=flarum.core.compat["common/components/Page"];var R=e.n(x);const P=flarum.core.compat["common/Component"];var A=e.n(P);const U=flarum.core.compat["common/components/LoadingIndicator"];var B=e.n(U);const F=flarum.core.compat["common/helpers/avatar"];var M=e.n(F);const L=flarum.core.compat["common/helpers/username"];var j=e.n(L);const O=flarum.core.compat["common/helpers/icon"];var C=e.n(O);const S=flarum.core.compat["common/helpers/humanTime"];var T=e.n(S);const D=flarum.core.compat["common/utils/withAttr"];var H=e.n(D),I=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.request=this.attrs.request,this.approved=g()("Rejected"),this.reason=g()(""),this.translationPrefix="piwind-username-request.forum."+(this.request.forNickname()?"nickname":"username")+"_modals.action"},s.title=function(){return n().translator.trans(this.translationPrefix+".title")},s.className=function(){return"RequestActionModal Modal--medium"},s.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("h3",{className:"Notification-content"},n().translator.trans(this.translationPrefix+".name",{name:j()(this.request.user()),requestedName:this.request.requestedUsername()})),m("p",{className:"help"},n().translator.trans(this.translationPrefix+".help_text")),m("legend",null,n().translator.trans(this.translationPrefix+".decision_title")),m("div",{className:"Form-group"},m("label",{className:"checkbox"},m("input",{type:"radio",name:"approved",value:"Approved",checked:"Approved"===this.approved(),onclick:H()("value",this.approved)}),n().translator.trans(this.translationPrefix+".approval_label")),m("label",{className:"checkbox"},m("input",{type:"radio",name:"rejected",value:"Rejected",checked:"Rejected"===this.approved(),onclick:H()("value",this.approved)}),n().translator.trans(this.translationPrefix+".rejected_label"))),"Rejected"===this.approved()?m("div",{className:"Form-group"},m("legend",null,n().translator.trans(this.translationPrefix+".reason_title")),m("div",{className:"BasicsPage-reason-input"},m("textarea",{className:"FormControl",value:this.reason(),disabled:this.loading,oninput:H()("value",this.reason)}))):"",m("div",{className:"Form-group"},v().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading,disabled:"Rejected"===this.approved()&&!this.reason()},n().translator.trans(this.translationPrefix+".submit_button")))))},s.onsubmit=function(e){var t=this;e.preventDefault(),this.loading=!0,this.request.save({reason:this.reason(),action:this.approved()}).then((function(){t.successAlert=n().alerts.show({type:"success"},n().translator.trans(t.translationPrefix+".success"))})),n().cache.username_requests.some((function(e,s){e.id()==t.request.id()&&n().cache.username_requests.splice(s,1)})),m.redraw(),this.hide()},t}(k()),G=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.loading=!1},s.view=function(){var e=this,t=n().cache.username_requests||[];return m("div",{className:"NotificationList RequestsList"},m("div",{className:"NotificationList-header"},m("h4",{className:"App-titleControl App-titleControl--text"},n().translator.trans("piwind-username-request.forum.pending_requests.title"))),m("div",{className:"NotificationList-content"},m("ul",{className:"NotificationGroup-content"},t.length?t.map((function(t){var s=t.forNickname()?"nickname":"username";return m("li",null,m("a",{onclick:e.showModal.bind(e,t),className:"Notification Request"},M()(t.user()),C()("fas fa-user-edit",{className:"Notification-icon"}),m("span",{className:"Notification-content"},n().translator.trans("piwind-username-request.forum.pending_requests."+s+"_item_text",{name:j()(t.user())})),T()(t.createdAt()),m("div",{className:"Notification-excerpt"},n().translator.trans("piwind-username-request.forum.pending_requests."+s+"_exerpt",{requestedName:t.requestedUsername()}))))})):this.loading?B().component({className:"LoadingIndicator--block"}):m("div",{className:"NotificationList-empty"},n().translator.trans("piwind-username-request.forum.pending_requests.empty_text")))))},s.showModal=function(e){n().modal.show(I,{request:e})},t}(A()),z=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),n().history.push("requests"),n().usernameRequests.load(),this.bodyClass="App--requests"},s.view=function(){return m("div",{className:"RequestsPage"},m(G,{state:n().usernameRequests}))},t}(R());const E=flarum.core.compat["forum/components/HeaderSecondary"];var J=e.n(E);const K=flarum.core.compat["forum/components/NotificationsDropdown"];var Q=function(e){function t(){return e.apply(this,arguments)||this}c(t,e),t.initAttrs=function(t){t.label=t.label||n().translator.trans("piwind-username-request.forum.pending_requests.tooltip"),t.icon=t.icon||"fas fa-user-edit",e.initAttrs.call(this,t)};var s=t.prototype;return s.getMenu=function(){return m("div",{className:"Dropdown-menu "+this.attrs.menuClassName,onclick:this.menuClick.bind(this)},this.showing?G.component({state:n().usernameRequests}):"")},s.goToRoute=function(){m.route.set(n().route("username_requests"))},s.getUnreadCount=function(){return n().cache.username_requests?n().cache.username_requests.length:n().forum.data.relationships.username_requests.data.length},s.getNewCount=function(){return n().cache.username_requests?n().cache.username_requests.length:n().forum.data.relationships.username_requests.data.length},t}(e.n(K)()),V=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.userRequestAttr="last"+(this.attrs.nickname?"Nickname":"Username")+"Request",this.request=n().session.user[this.userRequestAttr](),this.translationPrefix="piwind-username-request.forum."+(this.request.forNickname()?"nickname":"username")+"_modals.results"},s.className=function(){return"ResultsModal Modal"},s.title=function(){return n().translator.trans(this.translationPrefix+".title")},s.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},"Approved"===this.request.status()?[m("h2",null,n().translator.trans(this.translationPrefix+".approved")),m("h3",null,n().translator.trans(this.translationPrefix+".new_name",{name:n().session.user.displayName()}))]:[m("h2",null,n().translator.trans(this.translationPrefix+".rejected")),m("h3",null,n().translator.trans(this.translationPrefix+".reason",{reason:this.request.reason(),i:m("i",null)})),m("p",{className:"helpText"},n().translator.trans(this.translationPrefix+".resubmit"))],m("div",{className:"Form-group"},m(v(),{className:"Button Button--primary Button--block",onclick:this.hide.bind(this)},n().translator.trans(this.translationPrefix+".dismiss_button")))))},s.onremove=function(){n().session.user[this.userRequestAttr]=g()(),this.request.save({delete:!0})},t}(k());const W=flarum.core.compat["forum/components/UserPage"];var X=e.n(W),Y=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.loading=!0,this.loadUser(m.route.param("username"))},s.content=function(){var e=this;return m("table",{className:"NotificationGrid"},this.user.usernameHistory().slice(0).reverse().map((function(t){var s=Object.keys(t)[0];return m("tr",null,m("td",null,s),m("td",null,T()(e.calculateTime(t[s]))))})))},s.show=function(e){this.user=e,m.redraw()},s.calculateTime=function(e){return new Date(0).setUTCSeconds(e)},t}(X());const Z=flarum.core.compat["common/components/LinkButton"];var $=e.n(Z),ee=function(){function e(e){this.app=e,this.loading=!1,this.cache=[]}return e.prototype.load=function(){var e=this;n().cache.username_requests||(this.loading=!0,m.redraw(),n().store.find("username-requests").then((function(e){delete e.payload,n().cache.username_requests=e.sort((function(e,t){return e.createdAt()-t.createdAt()}))})).catch((function(){})).then((function(){e.loading=!1,m.redraw()})))},e}();n().initializers.add("piwind-username-request",(function(){n().store.models["username-requests"]=h,a().prototype.lastNicknameRequest=i().hasOne("lastNicknameRequest"),a().prototype.lastUsernameRequest=i().hasOne("lastUsernameRequest"),a().prototype.usernameHistory=i().attribute("usernameHistory"),n().routes.username_requests={path:"/username-requests",component:z},n().routes.username_history={path:"/u/:username/history",component:Y},n().usernameRequests=new ee(n()),(0,f.extend)(y().prototype,"accountItems",(function(e){n().forum.attribute("canRequestUsername")&&e.add("username-request",v().component({className:"Button",onclick:function(){n().modal.show(w)}},n().translator.trans("piwind-username-request.forum.settings.username_request_button")),8),"nickname"===n().forum.attribute("displayNameDriver")&&n().forum.attribute("canRequestNickname")&&!this.user.attribute("canEditOwnNickname")&&"flarum-nicknames"in flarum.extensions&&e.add("nickname-request",v().component({className:"Button",onclick:function(){n().modal.show(w,{nickname:!0})}},n().translator.trans("piwind-username-request.forum.settings.nickname_request_button")),8)})),(0,f.extend)(J().prototype,"items",(function(e){(n().forum.data.relationships.username_requests&&n().forum.data.relationships.username_requests.data.length&&!n().cache.username_requests||n().cache.username_requests&&0!==n().cache.username_requests.length)&&e.add("UsernameRequests",m(Q,{state:n().usernameRequests}),20)})),new Promise((function(){setTimeout((function(){if(n().session.user){var e=n().session.user.lastNicknameRequest()&&"Sent"!==n().session.user.lastNicknameRequest().status(),t=n().session.user.lastUsernameRequest()&&"Sent"!==n().session.user.lastUsernameRequest().status();(e||t)&&n().modal.show(V,{nickname:e})}}),1e3)})),(0,f.extend)(X().prototype,"navItems",(function(e){this.user.usernameHistory()&&e.add("username-requests",$().component({href:n().route("username_history",{username:this.user.slug()}),icon:"fas fa-user-edit"},n().translator.trans("piwind-username-request.forum.user.name_history_link")))}))}))})(),module.exports=t})();
//# sourceMappingURL=forum.js.map